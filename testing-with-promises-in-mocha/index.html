<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="description" content="Writing Mocha tests for code that uses promises"><style>.svg-inline--fa {
      display: none;
    }</style><link rel="stylesheet" href="/styles/1.29.0/index.css"><link rel="canonical" href="https://paulsalaets.com/"><link rel="alternate" type="application/rss+xml" title="Subscribe to posts" href="/feed.xml"><title>Testing with Promises in Mocha | paulsalaets.com</title></head><body class="text-base font-sans text-gray-900"><header class="p-4 mx-auto sm:max-w-3xl sm:px-20"><a href="#main" class="skipnav">skip to main content</a><nav><a class="font-bold text-sm sm:text-base inline-block mr-3" href="/" title="Home">Paul Salaets </a><a class="px-3 py-2" href="/" title="Home"><span class="text-sm sm:text-base inline-block">Home </span></a><a class="px-3 py-2" href="/about" title="About"><span class="text-sm sm:text-base inline-block">About </span></a><a class="px-3 py-2" href="/archive" title="Archive"><span class="text-sm sm:text-base inline-block">Archive </span></a><a class="px-3 py-2" href="/feed.xml" title="Feed"><span class="sr-only">RSS Feed</span> <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" class="svg-inline--fa fa-rss fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg></a></nav></header><main id="main" class="pb-4"><div class="mx-auto bg-white p-4 sm:max-w-3xl sm:px-20"><article><header class="mb-8"><h1 class="text-3xl font-bold">Testing with Promises in Mocha</h1><span class="text-sm">13 Jan 2015</span></header><section class="post-content"><p>As of Mocha <a href="https://github.com/mochajs/mocha/blob/master/HISTORY.md#1180--2014-03-13" rel="noopener">1.18.0</a> you can return a promise from a test and the test will pass if the promise is fulfilled or fail if the promise is rejected.</p><p><strong>Versions used below</strong></p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token string">"mocha"</span><span class="token punctuation">:</span> <span class="token string">"1.18.0"</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><h2>Overview</h2><p>The basic pattern is</p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'does something async with promises'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> <span class="token function">somethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>Things to note here</p><ul><li>Test function <em>does not</em> declare a <code>done</code> parameter like it would if this used callbacks</li><li>The promise from <code>somethingAsync</code> is returned</li></ul><h2>Verify a fulfilled promise</h2><p>You can assert all you want inside the fulfill handler. Errors thrown by the fulfill handler cause the resulting promise to be rejected. That's fine, the test should fail if any of its asserts fail.</p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'does something async with promises'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> <span class="token function">somethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><h2>Verify a rejected promise</h2><p>When the code-under-test is expected to return a rejected promise, the promise can't be returned directly to Mocha or the test will fail.</p><p>By specifying a reject handler in the <code>then</code> call, the error is &quot;caught&quot;, the resulting promise is fulfilled and the test passes.</p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'returns rejected promise on bad input'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> <span class="token function">somethingAsync</span><span class="token punctuation">(</span><span class="token string">'bad input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Promise was unexpectedly fulfilled. Result: '</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>Asserts are fine in the reject handler because if they fail, an Error is thrown and the resulting promise will be rejected.</p></section></article></div></main><footer class="p-8 text-center text-sm border-t-2 border-gray-200"><span>Â©2019 Paul Salaets</span><br><span>Built with <a href="https://www.11ty.io/" rel="noopener" class="text-blue-700 underline">Eleventy</a> and <a href="https://tailwindcss.com/" rel="noopener" class="text-blue-700 underline">Tailwind CSS</a></span></footer></body></html>