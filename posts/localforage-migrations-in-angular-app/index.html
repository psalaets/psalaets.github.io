<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="description" content="A module to migrate localForage data in an Angular app"><link rel="stylesheet" href="/1.7.0/main.css"><link rel="canonical" href="https://paulsalaets.com/"><title>localForage migrations in an Angular app | paulsalaets.com</title></head><body class="font-base font-sans text-gray-900"><header class="p-4 sm:p-8"><a href="#main" class="skipnav">skip to main content</a><nav><a class="font-bold text-sm sm:text-base inline-block mr-4" href="/" title="Home">Paul Salaets </a><a class="text-sm sm:text-base inline-block mr-4" href="/" title="Home">Home </a><a class="text-sm sm:text-base inline-block mr-4" href="/about" title="About">About </a><a class="text-sm sm:text-base inline-block mr-4" href="/archive" title="Archive">Archive</a></nav></header><main id="main" class="pb-4"><div class="mx-auto bg-white p-4 sm:max-w-3xl sm:px-16"><article><header class="mb-8"><h1 class="text-3xl font-bold">localForage migrations in an Angular app</h1><span class="text-sm">17 Mar 2015</span></header><section class="post-content"><p>My Angular app's offline data schema needed to change and I had to preserve existing data.</p><h3>Versions used below</h3><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token string">"angular"</span><span class="token punctuation">:</span> <span class="token string">"1.3.14"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token string">"localforage"</span><span class="token punctuation">:</span> <span class="token string">"1.2.2"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token string">"angular-localforage"</span><span class="token punctuation">:</span> <span class="token string">"1.2.2"</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><h2>What is data migration?</h2><p>When your data schema changes, existing data needs to be converted to the new format. By &quot;schema&quot; I just mean whatever structure your data is in.</p><p>For example, in version 2 of your app a friends array was added to the person object. Any people created <em>before</em> version 2 need to be given a friends array.</p><h2>Basic idea</h2><p>Put pending migrations behind a promise and chain all data access off of that promise. The promise acts as a gatekeeper ensuring no data access occurs until the migrations are finished.</p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token keyword">function</span> <span class="token function">migrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">var</span> migrationPromise <span class="token operator">=</span> <span class="token operator">&lt;</span>data migrations here<span class="token operator">></span></span><br><span class="highlight-line">  <span class="token keyword">return</span> migrationPromise<span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">function</span> <span class="token function">loadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token comment">// run data access only after data migrations are done</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> <span class="token function">migrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> $localForage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><h2>Migrations service</h2><p>The logic to create <code>migrationPromise</code> tends to be a little messy so it moves to its own service.</p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line">angular<span class="token punctuation">.</span><span class="token function">module</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token string">'migrations'</span><span class="token punctuation">,</span> migrations<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">function</span> <span class="token function">migrations</span><span class="token punctuation">(</span><span class="token parameter">$localForage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">var</span> migrationPromise<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token function-variable function">migrate</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token comment">// if promise is not set yet, migration needs to be run</span></span><br><span class="highlight-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>migrationPromise<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        migrationPromise <span class="token operator">=</span> $localForage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'people'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">people</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">          <span class="token comment">// add friends array to each existing person</span></span><br><span class="highlight-line">          people<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">person</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            person<span class="token punctuation">.</span>friends <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line">          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">          <span class="token keyword">return</span> $localForage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'people'</span><span class="token punctuation">,</span> people<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">      <span class="token keyword">return</span> migrationPromise<span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><h2>Multiple migrations</h2><p>With migrations in subsequent versions of an app, a user's data could be anywhere along the migration timeline. Depending on what the migrations do, you might not be able to run all migrations every time the app is loaded.</p><p>To know how far a user's data has been migrated, give migrations increasing id numbers and keep track of the highest migration id that has been run.</p><h2>Angular provider recipe</h2><p>The only interesting parts are the actual migrations. The framework around migration execution doesn't change.</p><p>We could use the <a href="https://code.angularjs.org/1.3.14/docs/guide/providers#provider-recipe">Angular provider recipe</a> to package up migration execution code. Each migration would be added to the provider in a <a href="https://code.angularjs.org/1.3.14/docs/api/ng/type/angular.Module#config">module config block</a>.</p><h2>angular-localforage-migrations</h2><p>All of the ideas above have been put into a module called <a href="https://github.com/psalaets/angular-localforage-migrations">angular-localforage-migrations</a> which is available through npm and bower.</p></section></article></div></main><footer class="p-8 text-center text-sm border-t-2 border-gray-200"><span>©2019 Paul Salaets</span><br><span>Built with <a href="https://www.11ty.io/" rel="noopener noreferrer" class="text-blue-700 underline">Eleventy</a> and <a href="https://tailwindcss.com/" rel="noopener noreferrer" class="text-blue-700 underline">Tailwind CSS</a></span></footer></body></html>