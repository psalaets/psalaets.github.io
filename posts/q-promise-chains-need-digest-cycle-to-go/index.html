<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="description" content="$q promise chains will not propagate without a digest cycle"><link rel="stylesheet" href="/1.14.0/main.css"><link rel="canonical" href="https://paulsalaets.com/"><title>$q promise chains need a digest cycle to go | paulsalaets.com</title></head><body class="text-base font-sans text-gray-900"><header class="p-4 mx-auto sm:max-w-3xl sm:px-20"><a href="#main" class="skipnav">skip to main content</a><nav><a class="font-bold text-sm sm:text-base inline-block mr-3" href="/" title="Home">Paul Salaets </a><a class="px-3 py-2" href="/" title="Home"><span class="text-sm sm:text-base inline-block">Home </span></a><a class="px-3 py-2" href="/about" title="About"><span class="text-sm sm:text-base inline-block">About </span></a><a class="px-3 py-2" href="/archive" title="Archive"><span class="text-sm sm:text-base inline-block">Archive</span></a></nav></header><main id="main" class="pb-4"><div class="mx-auto bg-white p-4 sm:max-w-3xl sm:px-20"><article><header class="mb-8"><h1 class="text-3xl font-bold">$q promise chains need a digest cycle to go</h1><span class="text-sm">19 Feb 2015</span></header><section class="post-content"><p>In a Jasmine test for an Angular app, I stubbed a method that returns a $q promise. The test kept timing out even though I didn't forget about <code>done()</code>.</p><p><strong>Versions used below</strong></p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token string">"angular"</span><span class="token punctuation">:</span> <span class="token string">"1.3.8"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token string">"jasmine-core"</span><span class="token punctuation">:</span> <span class="token string">"2.1.3"</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><h2>Digest cycle needed</h2><p>Just like how a digest cycle is needed for Angular to notice changes to scope properties, a digest is needed for $q promise chain propagation.</p><p>When necessary, you can trigger a digest cycle by calling <code>$rootScope.$apply()</code>.</p><h2>Test with timeout fix</h2><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'beginGame()'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">var</span> gameService<span class="token punctuation">,</span> $rootScope<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token function">inject</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_gameService_<span class="token punctuation">,</span> _$rootScope_<span class="token punctuation">,</span> $q</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    gameService <span class="token operator">=</span> _gameService_<span class="token punctuation">;</span></span><br><span class="highlight-line">    $rootScope <span class="token operator">=</span> _$rootScope_<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token comment">// Stub method so it just returns a resolved promise.</span></span><br><span class="highlight-line">    <span class="token comment">// The controller being tested uses gameService.</span></span><br><span class="highlight-line">    <span class="token function">spyOn</span><span class="token punctuation">(</span>gameService<span class="token punctuation">,</span> <span class="token string">'start'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>and<span class="token punctuation">.</span><span class="token function">callFake</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">game</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">return</span> <span class="token function">$q</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token function">resolve</span><span class="token punctuation">(</span>game<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'starts a game with given players'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    controller<span class="token punctuation">.</span><span class="token function">addPlayers</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'jill'</span><span class="token punctuation">,</span> <span class="token string">'joe'</span><span class="token punctuation">,</span> <span class="token string">'jen'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token comment">// here's the $q promise chain</span></span><br><span class="highlight-line">    controller<span class="token punctuation">.</span><span class="token function">beginGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>assertGameStarted<span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">function</span> <span class="token function">assertGameStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token function">expect</span><span class="token punctuation">(</span>gameService<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span>jasmine<span class="token punctuation">.</span><span class="token function">objectContaining</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><span class="highlight-line">        playerNames<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'jill'</span><span class="token punctuation">,</span> <span class="token string">'joe'</span><span class="token punctuation">,</span> <span class="token string">'jen'</span><span class="token punctuation">]</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token comment">// manually trigger digest cycle</span></span><br><span class="highlight-line">    $rootScope<span class="token punctuation">.</span><span class="token function">$apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>Without line 32 the promise chain doesn't propagate, <code>done()</code> is never called and the test fails due to timeout.</p><h2>Why $q works fine in app code</h2><p>Digest cycles are triggered for you behind the scenes. Angular built-ins (ngClick, $timeout, etc) call <code>$rootScope.$apply()</code> which triggers a digest cycle.</p></section></article></div></main><footer class="p-8 text-center text-sm border-t-2 border-gray-200"><span>©2019 Paul Salaets</span><br><span>Built with <a href="https://www.11ty.io/" rel="noopener noreferrer" class="text-blue-700 underline">Eleventy</a> and <a href="https://tailwindcss.com/" rel="noopener noreferrer" class="text-blue-700 underline">Tailwind CSS</a></span></footer></body></html>