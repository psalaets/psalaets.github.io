<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="description" content="How to clean up rootScope event listeners and what happens when you forget"><link rel="stylesheet" href="/1.15.0/main.css"><link rel="canonical" href="https://paulsalaets.com/"><title>Cleaning up Angular $rootScope event listeners | paulsalaets.com</title></head><body class="text-base font-sans text-gray-900"><header class="p-4 mx-auto sm:max-w-3xl sm:px-20"><a href="#main" class="skipnav">skip to main content</a><nav><a class="font-bold text-sm sm:text-base inline-block mr-3" href="/" title="Home">Paul Salaets </a><a class="px-3 py-2" href="/" title="Home"><span class="text-sm sm:text-base inline-block">Home </span></a><a class="px-3 py-2" href="/about" title="About"><span class="text-sm sm:text-base inline-block">About </span></a><a class="px-3 py-2" href="/archive" title="Archive"><span class="text-sm sm:text-base inline-block">Archive</span></a></nav></header><main id="main" class="pb-4"><div class="mx-auto bg-white p-4 sm:max-w-3xl sm:px-20"><article><header class="mb-8"><h1 class="text-3xl font-bold">Cleaning up Angular $rootScope event listeners</h1><span class="text-sm">11 Mar 2015</span></header><section class="post-content"><p>When I started using ngIf I noticed some <code>$rootScope</code> event listeners firing more than once per event.</p><p><strong>Versions used below</strong></p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token string">"angular"</span><span class="token punctuation">:</span> <span class="token string">"1.3.14"</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><h2>Lifespan of $rootScope vs other scopes</h2><p><code>$rootScope</code> lives as long as your app, which is usually the duration of the page. Other scopes are not guaranteed to last that long, like when their directive is nested in ngIf or ngRepeat.</p><h2>Forgetting to clean up the listener</h2><p>When a directive like this</p><pre class="language-js"><code class="language-js"><span class="highlight-line">angular<span class="token punctuation">.</span><span class="token function">module</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'myDirective'</span><span class="token punctuation">,</span> myDirective<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">function</span> <span class="token function">myDirective</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    restrict<span class="token punctuation">:</span> <span class="token string">'E'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    scope<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      foo<span class="token punctuation">:</span> <span class="token string">'='</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token function-variable function">controller</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">$rootScope</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token comment">// problem: registered a listener but never cleans it up</span></span><br><span class="highlight-line">      $rootScope<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'someEvent'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><p>is used like this</p><pre class="language-html"><code class="language-html"><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ng-if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>flag<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><br><span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-directive</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>my-directive</span><span class="token punctuation">></span></span></span><br><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span></code></pre><p>an event listener will be left behind every time <code>flag</code> changes from <code>true</code> to <code>false</code>. A symptom of this is an event being handled more than once. The extra listeners are sometimes called &quot;zombie&quot; listeners.</p><h2>Cleaning up the listener</h2><p><code>$rootScope.$on()</code> returns a function that will deregister the listener. That function should be invoked when the directive's scope is destroyed.</p><p>With this in mind, the directive changes to</p><pre class="language-js"><code class="language-js"><span class="highlight-line">angular<span class="token punctuation">.</span><span class="token function">module</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'myDirective'</span><span class="token punctuation">,</span> myDirective<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">function</span> <span class="token function">myDirective</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    restrict<span class="token punctuation">:</span> <span class="token string">'E'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    scope<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      foo<span class="token punctuation">:</span> <span class="token string">'='</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token function-variable function">controller</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">$scope<span class="token punctuation">,</span> $rootScope</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token comment">// add listener and hold on to deregister function</span></span><br><span class="highlight-line">        <span class="token keyword">var</span> deregister <span class="token operator">=</span> $rootScope<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'someEvent'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">        <span class="token comment">// clean up listener when directive's scope is destroyed</span></span><br><span class="highlight-line">        $scope<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'$destroy'</span><span class="token punctuation">,</span> deregister<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre></section></article></div></main><footer class="p-8 text-center text-sm border-t-2 border-gray-200"><span>©2019 Paul Salaets</span><br><span>Built with <a href="https://www.11ty.io/" rel="noopener noreferrer" class="text-blue-700 underline">Eleventy</a> and <a href="https://tailwindcss.com/" rel="noopener noreferrer" class="text-blue-700 underline">Tailwind CSS</a></span></footer></body></html>