<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="description" content="How to make reusable processing pipelines in a Gulp build"><link rel="stylesheet" href="/1.3.0/main.css"><link rel="canonical" href="https://paulsalaets.com/"><title>Making reusable pipelines in a Gulp build | paulsalaets.com</title></head><body class="font-base font-sans text-gray-900"><header class="p-4 sm:p-8"><a href="#main" class="skipnav">skip to main content</a><nav><a class="font-bold text-sm sm:text-base inline-block mr-4" href="/" title="Home">Paul Salaets </a><a class="text-sm sm:text-base inline-block mr-4" href="/" title="Home">Home </a><a class="text-sm sm:text-base inline-block mr-4" href="/about" title="About">About </a><a class="text-sm sm:text-base inline-block mr-4" href="/archive" title="Archive">Archive</a></nav></header><main id="main" class="pb-4"><div class="mx-auto bg-white p-4 sm:max-w-3xl sm:px-16"><article><header class="mb-8"><h1 class="text-3xl font-bold">Making reusable pipelines in a Gulp build</h1><span class="text-sm">11 May 2015</span></header><section class="post-content"><p>Since a gulp build is just JavaScript code, you can make small processing pipelines and reuse them.</p><h3>Versions used below</h3><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token string">"gulp"</span><span class="token punctuation">:</span> <span class="token string">"3.8.11"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token string">"lazypipe"</span><span class="token punctuation">:</span> <span class="token string">"0.2.3"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token string">"stream-combiner2"</span><span class="token punctuation">:</span> <span class="token string">"1.0.2"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token string">"bun"</span><span class="token punctuation">:</span> <span class="token string">"0.0.11"</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><h2>Why reusable pipelines?</h2><p>A typical pattern for gulp tasks is</p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line">gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'taskName'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">stepA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">stepB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">stepC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>If some other task needs to run <code>stepB</code> and <code>stepC</code> you could copy/paste the code or move it out into something reusable. The latter will result in a more maintainable build.</p><p>In this post I'll make a reusable pipeline that will <a href="https://www.npmjs.com/package/gulp-uglify">uglify</a> and <a href="https://www.npmjs.com/package/gulp-rev">rev</a> JavaScript files.</p><h2>The manual way</h2><p>Here's a way to do it with no help from outside modules.</p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token comment">// make reusable pipeline</span></span><br><span class="highlight-line"><span class="token keyword">function</span> <span class="token function">processJs</span><span class="token punctuation">(</span><span class="token parameter">inputStream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> inputStream</span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// use it</span></span><br><span class="highlight-line">gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'taskName'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> <span class="token function">processJs</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>This works but it reads out of order -- the call to <code>gulp.src</code> is not first. In gulp builds I'm used to seeing code in the same order that the file processing happens in.</p><p>It looks worse when there are steps before the reusable pipeline.</p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line">gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'taskName'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">var</span> before <span class="token operator">=</span> gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">stepA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">stepB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token keyword">return</span> <span class="token function">processJs</span><span class="token punctuation">(</span>before<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><h3>Why pass inputStream in?</h3><p>It seems like the previous examples could be cleaner by not passing <code>inputStream</code> into <code>processJs</code>. We could just use <code>processJs()</code> directly in the gulp task.</p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token comment">// DOES NOT WORK</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// make reusable pipeline</span></span><br><span class="highlight-line"><span class="token keyword">function</span> <span class="token function">processJs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> <span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// use it</span></span><br><span class="highlight-line">gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'taskName'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">processJs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>This runs but it doesn't give the desired effect.</p><p>In node streams <code>a.pipe(b)</code> returns <code>b</code>. That means <code>processJs</code> returns a <code>rev</code> stream and <code>gulp.src</code> will pipe directly into it. Even though <code>uglify</code> is also piped into <code>rev</code>, nothing pipes into <code>uglify</code> so it has no effect.</p><p>Okay, on to some better ideas.</p><h2>Using lazypipe</h2><p><a href="https://www.npmjs.com/package/lazypipe">lazypipe</a> creates a function that lazily creates your pipeline.</p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token keyword">var</span> lazypipe <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lazypipe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// make reusable pipeline</span></span><br><span class="highlight-line"><span class="token keyword">var</span> processJs <span class="token operator">=</span> <span class="token function">lazypipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>uglify<span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>rev<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// use it</span></span><br><span class="highlight-line">gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'taskName'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">processJs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><p>This is nicer because the code is in the same order as the file processing.</p><h3>Passing parameters to gulp plugins</h3><p>The previous code example uses <code>.pipe(uglify)</code> instead of <code>.pipe(uglify())</code> because lazypipe will invoke <code>uglify</code> for us when needed. We lost our chance to pass an options object to <code>uglify</code>.</p><p>lazypipe's <code>.pipe()</code> accepts extra parameters which are passed directly to the plugin.</p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token keyword">var</span> uglifyOptions <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  mangle<span class="token punctuation">:</span> <span class="token boolean">false</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">var</span> processJs <span class="token operator">=</span> <span class="token function">lazypipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>uglify<span class="token punctuation">,</span> uglifyOptions<span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>rev<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><h3>Gotcha with gulp-if</h3><p>With lazypipe it's tricky to use streams that take other streams, e.g. <a href="https://www.npmjs.com/package/gulp-if">gulp-if</a>.</p><p>Common gulp-if usage looks like</p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">gulpif</span><span class="token punctuation">(</span>condition<span class="token punctuation">,</span> <span class="token function">thenThisStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">otherwiseThisStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre><p>If we do that when building the lazypipe it's no longer lazy and no longer reusable. There is a <a href="https://github.com/OverZealous/lazypipe#using-with-more-complex-function-arguments-such-as-gulp-if">way around that</a> but this is more special case handling than I'd like in a build file.</p><h2>Using stream-combiner2</h2><p><a href="https://www.npmjs.com/package/stream-combiner2">stream-combiner2</a> wraps a series of streams into a single duplex stream.</p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token keyword">var</span> combiner <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream-combiner2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">var</span> wrapper <span class="token operator">=</span> <span class="token function">combiner</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><p>Things to note:</p><ol><li><code>a</code>, <code>b</code> and <code>c</code> are piped together inside <code>wrapper</code></li><li>Input to <code>wrapper</code> is the input to <code>a</code></li><li>Output of <code>c</code> is the output of <code>wrapper</code></li><li>Errors from <code>a</code>, <code>b</code> and <code>c</code> become errors of <code>wrapper</code></li></ol><p>With that in mind, we can do</p><pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token keyword">var</span> combiner <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream-combiner2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// make reusable pipeline</span></span><br><span class="highlight-line"><span class="token keyword">function</span> <span class="token function">processJs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> <span class="token function">combiner</span><span class="token punctuation">(</span></span><br><span class="highlight-line">    <span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// use it</span></span><br><span class="highlight-line">gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'taskName'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">processJs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><p>This is my preferred approach for creating reusable pipelines in a gulp build.</p><h3>Similar module</h3><p><a href="https://www.npmjs.com/package/bun">bun</a> works like stream-combiner2 except it takes an <em>array</em> of streams.</p></section></article></div></main><footer class="p-8 text-center text-sm border-t-2 border-gray-200"><span>©2019 Paul Salaets</span><br><span>Built with <a href="https://www.11ty.io/" rel="noopener noreferrer" class="text-blue-700 underline">Eleventy</a> and <a href="https://tailwindcss.com/" rel="noopener noreferrer" class="text-blue-700 underline">Tailwind CSS</a></span></footer></body></html>